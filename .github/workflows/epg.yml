name: Generate EPGs Daily

on:
  schedule:
    - cron: "0 0 * * *"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: windows-latest
    steps:
      # -------------------------------
      # CHECKOUT REPO
      # -------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # -------------------------------
      # PYTHON SETUP
      # -------------------------------
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install Python dependencies
        shell: pwsh
        run: |
          python -m pip install --upgrade pip
          if (Test-Path requirements.txt) {
            pip install -r requirements.txt
          } else {
            pip install requests beautifulsoup4 pytz
          }

      # -------------------------------
      # RUN ALL PYTHON SCRIPTS
      # -------------------------------
      - name: Run all EPG generator scripts
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Continue'
          $scripts = @(
            "Fetch.Epgs.py",
            "Al-Jazeera.py",
            "DW.py",
            "TRT-World.py",
            "NHK-World.py",
            "CNA.py",
            "CGTN.py",
            "RT.py",
            "France-24.py",
            "Sky-News.py",
            "BBC-News.py",
            "CNN.py",
            "CNN-International.py",
            "CNN-News-18.py",
            "CNBC-TV-18.py",
            "CNBC.py",
            "CNBC-World.py",
            "MSNBC.py",
            "ABC-News-AU.py",
            "GB-News.py",
            "Euronews.py",
            "Africanews.py",
            "Global-News.py",
            "WION.py",
            "Firstpost.py",
            "Reuters.py",
            "ABC-News-Live.py",
            "LiveNOW-from-FOX.py",
            "NBC-News-Now.py",
            "HLN.py",
            "ABC.py",
            "Fox-News-Channel.py",
            "Fox-Business.py",
            "Bloomberg.py",
            "Yahoo-Finance.py",
            "Republic-TV.py",
            "Zee-News.py",
            "CGTN-Documentary.py",
            "RT-Documentary.py",
            "Documentary-Plus.py",
            "VICE.py",
            "Bloomberg-Originals.py",
            "CNN-Originals.py",
            "Geo-Entertainment.py",
            "Green-Entertainment.py",
            "Aaj-Entertainment.py",
            "Hum-TV.py",
            "Ary-News.py",
            "Ary-Digital.py",
            "Ary-Zauq.py",
            "Ary-Zauq2.py",
            "Ary-QTV.py",
            "Geo-News.py",
            "AJK-Television.py",
            "PTV-Bolan.py",
            "PTV-Global.py",
            "PTV-Home.py",
            "PTV-National.py",
            "PTV-News.py",
            "PTV-Sports.py",
            "Express-Entertainment.py",
            "Hum-Europe.py",
            "Hum-Masala.py",
            "9XM.py",
            "9X-Jalwa.py",
            "Zoom.py",
            "B4U-Music.py",
            "Mastiii.py",
            "YRF-Music.py",
            "myTV.py",
            "PakistanEPG-Package.py"
          )
          foreach ($s in $scripts) {
            if (Test-Path $s) {
              Write-Host "Running $s ..."
              python "$s"
              if ($LASTEXITCODE -ne 0) {
                Write-Host "⚠ FAILED: $s (exit $LASTEXITCODE) — continuing"
                $global:LASTEXITCODE = 0
              }
            } else {
              Write-Host "⚠ SKIPPED: $s (file missing)"
            }
          }

      # -------------------------------
      # UPLOAD ARTIFACTS
      # -------------------------------
      - name: Upload countries XMLs
        uses: actions/upload-artifact@v4
        with:
          name: countries-xml
          path: countries

      - name: Upload channels XMLs
        uses: actions/upload-artifact@v4
        with:
          name: channels-xml
          path: channels

      - name: Upload myTV package
        uses: actions/upload-artifact@v4
        with:
          name: myTV-package
          path: package

      # -------------------------------
      # COMMIT & PUSH CHANGES
      # -------------------------------
      - name: Commit and push changes
        shell: pwsh
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add channels package countries
          if (git diff --cached --quiet) {
            Write-Host "No changes to commit."
          } else {
            $date = Get-Date -Format "yyyy-MM-dd HH:mm:ss"
            git commit -m "Update EPGs ($date)"
            git push
          }
