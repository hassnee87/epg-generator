name: Generate EPGs Daily

on:
  schedule:
    - cron: "0 0 * * *"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: windows-latest
    steps:
      # -------------------------------
      # CHECKOUT REPO
      # -------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # -------------------------------
      # PYTHON SETUP
      # -------------------------------
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install Python dependencies
        shell: pwsh
        run: |
          python -m pip install --upgrade pip
          if (Test-Path requirements.txt) {
            pip install -r requirements.txt
          } else {
            pip install requests beautifulsoup4 pytz
          }

      # -------------------------------
      # RUN ALL PYTHON SCRIPTS
      # -------------------------------
      - name: Run all EPG generator scripts
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Continue'
          $scripts = @(
            "Fetch.Epgs.py",
            "GROAT-NZ.py",
            "Big-Rig-NZ.py",
            "Melo-NZ.py",
            "Juice-TV-NZ.py",
            "J2-NZ.py",
            "CH200-NZ.py",
            "TVSN-Shopping-NZ.py",
            "Firstlight-NZ.py",
            "Hope-Channel-NZ.py"
            "myTV.py",
            "PakistanEPG-Package.py"
          )
          foreach ($s in $scripts) {
            if (Test-Path $s) {
              Write-Host "Running $s ..."
              python "$s"
              if ($LASTEXITCODE -ne 0) {
                Write-Host "⚠ FAILED: $s (exit $LASTEXITCODE) — continuing"
                $global:LASTEXITCODE = 0
              }
            } else {
              Write-Host "⚠ SKIPPED: $s (file missing)"
            }
          }

      # -------------------------------
      # UPLOAD ARTIFACTS
      # -------------------------------
      - name: Upload countries XMLs
        uses: actions/upload-artifact@v4
        with:
          name: countries-xml
          path: countries

      - name: Upload channels XMLs
        uses: actions/upload-artifact@v4
        with:
          name: channels-xml
          path: channels

      - name: Upload myTV package
        uses: actions/upload-artifact@v4
        with:
          name: myTV-package
          path: package

      # -------------------------------
      # COMMIT & PUSH CHANGES
      # -------------------------------
      - name: Commit and push changes
        shell: pwsh
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add channels package countries
          if (git diff --cached --quiet) {
            Write-Host "No changes to commit."
          } else {
            $date = Get-Date -Format "yyyy-MM-dd HH:mm:ss"
            git commit -m "Update EPGs ($date)"
            git push
          }
